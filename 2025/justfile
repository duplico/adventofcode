# Advent of Code 2025 - Task Runner
# Install: cargo install just (or: brew install just, apt install just)
# Usage: just new 02 python

set shell := ["bash", "-uc"]

# Default recipe: show help
default:
    @just --list

# Create a new day/language from a skeleton
# Usage: just new <day> <language>
# Example: just new 02 python
new day lang:
    #!/usr/bin/env bash
    set -euo pipefail

    DAY="{{day}}"
    LANG="{{lang}}"
    SKEL_DIR="skel/${LANG}"
    TARGET_DIR="${DAY}/${LANG}"

    # Validate day format (01-25)
    if [[ ! "$DAY" =~ ^[0-2][0-9]$ ]]; then
        echo "Error: Day must be two digits (01-25), got: $DAY"
        exit 1
    fi

    # Check skeleton exists
    if [[ ! -d "$SKEL_DIR" ]]; then
        echo "Error: No skeleton found for language '$LANG'"
        echo "Available languages:"
        ls -1 skel/
        exit 1
    fi

    # Check target doesn't exist
    if [[ -d "$TARGET_DIR" ]]; then
        echo "Error: Directory '$TARGET_DIR' already exists"
        exit 1
    fi

    # Create day directory if needed
    mkdir -p "$DAY"

    # Create shared input files if they don't exist
    touch "$DAY/input.txt"
    touch "$DAY/sample_input.txt"

    # Copy skeleton to language subdirectory
    cp -r "$SKEL_DIR" "$TARGET_DIR"

    # Language-specific post-processing
    case "$LANG" in
        python)
            echo "Initializing Python project with uv..."
            cd "$TARGET_DIR" && uv sync
            ;;
        go)
            echo "Initializing Go module..."
            cd "$TARGET_DIR" && go mod tidy
            ;;
        rust)
            echo "Rust project ready. Run 'cargo build' to compile."
            ;;
        clojure)
            echo "Clojure project ready. Run 'clj -M:run 1 ../input.txt' to start."
            ;;
        c)
            echo "C project ready. Run 'make' to compile."
            ;;
        tcl)
            echo "Tcl project ready. Run 'tclsh advent.tcl 1 ../input.txt' to start."
            ;;
    esac

    echo ""
    echo "✓ Created day $DAY/$LANG"
    echo ""
    echo "Directory structure:"
    echo "  $DAY/"
    echo "  ├── input.txt          # Your puzzle input"
    echo "  ├── sample_input.txt   # Sample input from puzzle"
    echo "  └── $LANG/             # Your solution"
    echo ""
    echo "Next steps:"
    echo "  1. Paste your puzzle input into $DAY/input.txt"
    echo "  2. Paste sample input into $DAY/sample_input.txt"
    echo "  3. cd $TARGET_DIR && start coding!"

# List available skeleton languages
langs:
    @echo "Available languages:"
    @ls -1 skel/

# List languages used for a specific day
day-langs day:
    #!/usr/bin/env bash
    DAY="{{day}}"
    if [[ ! -d "$DAY" ]]; then
        echo "Day $DAY does not exist"
        exit 1
    fi
    echo "Languages for day $DAY:"
    for dir in "$DAY"/*/; do
        if [[ -d "$dir" ]]; then
            basename "$dir"
        fi
    done

# Run a solution
# Usage: just run <day> <language> <part> [args...]
# Example: just run 02 python 1 -v
run day lang part *args:
    #!/usr/bin/env bash
    set -euo pipefail

    DAY="{{day}}"
    LANG="{{lang}}"
    PART="{{part}}"
    ARGS="{{args}}"
    TARGET_DIR="${DAY}/${LANG}"

    if [[ ! -d "$TARGET_DIR" ]]; then
        echo "Error: $TARGET_DIR does not exist"
        echo "Create it with: just new $DAY $LANG"
        exit 1
    fi

    cd "$TARGET_DIR"

    case "$LANG" in
        python)
            uv run advent "$PART" ../input.txt $ARGS
            ;;
        rust)
            cargo run --release -- "$PART" ../input.txt $ARGS
            ;;
        go)
            go run . "$PART" ../input.txt $ARGS
            ;;
        clojure)
            clj -M:run "$PART" ../input.txt $ARGS
            ;;
        c)
            make -s && ./advent "$PART" ../input.txt $ARGS
            ;;
        tcl)
            tclsh advent.tcl "$PART" ../input.txt $ARGS
            ;;
        *)
            echo "Error: Unknown language '$LANG'"
            exit 1
            ;;
    esac

# Run with sample input
# Usage: just sample <day> <language> <part> [args...]
sample day lang part *args:
    #!/usr/bin/env bash
    set -euo pipefail

    DAY="{{day}}"
    LANG="{{lang}}"
    PART="{{part}}"
    ARGS="{{args}}"
    TARGET_DIR="${DAY}/${LANG}"

    if [[ ! -d "$TARGET_DIR" ]]; then
        echo "Error: $TARGET_DIR does not exist"
        exit 1
    fi

    cd "$TARGET_DIR"

    case "$LANG" in
        python)
            uv run advent "$PART" ../sample_input.txt $ARGS
            ;;
        rust)
            cargo run -- "$PART" ../sample_input.txt $ARGS
            ;;
        go)
            go run . "$PART" ../sample_input.txt $ARGS
            ;;
        clojure)
            clj -M:run "$PART" ../sample_input.txt $ARGS
            ;;
        c)
            make -s && ./advent "$PART" ../sample_input.txt $ARGS
            ;;
        tcl)
            tclsh advent.tcl "$PART" ../sample_input.txt $ARGS
            ;;
        *)
            echo "Error: Unknown language '$LANG'"
            exit 1
            ;;
    esac

# Open a REPL for a day/language (where supported)
# Usage: just repl <day> <language>
# Example: just repl 02 clojure
repl day lang:
    #!/usr/bin/env bash
    set -euo pipefail

    DAY="{{day}}"
    LANG="{{lang}}"
    TARGET_DIR="${DAY}/${LANG}"

    if [[ ! -d "$TARGET_DIR" ]]; then
        echo "Error: $TARGET_DIR does not exist"
        echo "Create it with: just new $DAY $LANG"
        exit 1
    fi

    cd "$TARGET_DIR"

    case "$LANG" in
        python)
            uv run python -i -c "from advent import *; print('Advent module loaded. Functions available.')"
            ;;
        clojure)
            clj -M:rebel
            ;;
        tcl)
            tclsh
            ;;
        *)
            echo "Error: REPL not supported for '$LANG'"
            echo "Supported languages: python, clojure, tcl"
            exit 1
            ;;
    esac
